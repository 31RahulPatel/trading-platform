pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'your-registry.com'
        SONARQUBE_SERVER = 'sonarqube'
        KUBECONFIG = credentials('kubeconfig')
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh 'npm ci'
            }
        }
        
        stage('Lint & Test') {
            parallel {
                stage('Lint') {
                    steps {
                        sh 'npm run lint'
                    }
                }
                stage('Test') {
                    steps {
                        sh 'npm run test'
                        publishTestResults testResultsPattern: '**/test-results.xml'
                    }
                }
            }
        }
        
        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonarqube') {
                    sh 'sonar-scanner'
                }
            }
        }
        
        stage('Build Services') {
            parallel {
                stage('Auth Service') {
                    steps {
                        script {
                            def image = docker.build("${DOCKER_REGISTRY}/auth-service:${BUILD_NUMBER}", "./services/auth-service")
                            docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-registry-credentials') {
                                image.push()
                                image.push("latest")
                            }
                        }
                    }
                }
                stage('Order Service') {
                    steps {
                        script {
                            def image = docker.build("${DOCKER_REGISTRY}/order-service:${BUILD_NUMBER}", "./services/order-service")
                            docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-registry-credentials') {
                                image.push()
                                image.push("latest")
                            }
                        }
                    }
                }
                stage('Portfolio Service') {
                    steps {
                        script {
                            def image = docker.build("${DOCKER_REGISTRY}/portfolio-service:${BUILD_NUMBER}", "./services/portfolio-service")
                            docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-registry-credentials') {
                                image.push()
                                image.push("latest")
                            }
                        }
                    }
                }
                stage('Admin Service') {
                    steps {
                        script {
                            def image = docker.build("${DOCKER_REGISTRY}/admin-service:${BUILD_NUMBER}", "./services/admin-service")
                            docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-registry-credentials') {
                                image.push()
                                image.push("latest")
                            }
                        }
                    }
                }
                stage('Order Worker') {
                    steps {
                        script {
                            def image = docker.build("${DOCKER_REGISTRY}/order-worker:${BUILD_NUMBER}", "./services/order-worker")
                            docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-registry-credentials') {
                                image.push()
                                image.push("latest")
                            }
                        }
                    }
                }
            }
        }
        
        stage('Security Scan') {
            steps {
                sh 'trivy image ${DOCKER_REGISTRY}/auth-service:${BUILD_NUMBER}'
                sh 'trivy image ${DOCKER_REGISTRY}/order-service:${BUILD_NUMBER}'
                sh 'trivy image ${DOCKER_REGISTRY}/portfolio-service:${BUILD_NUMBER}'
                sh 'trivy image ${DOCKER_REGISTRY}/admin-service:${BUILD_NUMBER}'
                sh 'trivy image ${DOCKER_REGISTRY}/order-worker:${BUILD_NUMBER}'
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                sh 'kubectl apply -f infrastructure/k8s/overlays/staging/'
                sh 'kubectl set image deployment/auth-service auth-service=${DOCKER_REGISTRY}/auth-service:${BUILD_NUMBER} -n staging'
                sh 'kubectl set image deployment/order-service order-service=${DOCKER_REGISTRY}/order-service:${BUILD_NUMBER} -n staging'
                sh 'kubectl set image deployment/portfolio-service portfolio-service=${DOCKER_REGISTRY}/portfolio-service:${BUILD_NUMBER} -n staging'
                sh 'kubectl set image deployment/admin-service admin-service=${DOCKER_REGISTRY}/admin-service:${BUILD_NUMBER} -n staging'
                sh 'kubectl set image deployment/order-worker order-worker=${DOCKER_REGISTRY}/order-worker:${BUILD_NUMBER} -n staging'
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                input message: 'Deploy to production?', ok: 'Deploy'
                sh 'kubectl apply -f infrastructure/k8s/overlays/production/'
                sh 'kubectl set image deployment/auth-service auth-service=${DOCKER_REGISTRY}/auth-service:${BUILD_NUMBER} -n production'
                sh 'kubectl set image deployment/order-service order-service=${DOCKER_REGISTRY}/order-service:${BUILD_NUMBER} -n production'
                sh 'kubectl set image deployment/portfolio-service portfolio-service=${DOCKER_REGISTRY}/portfolio-service:${BUILD_NUMBER} -n production'
                sh 'kubectl set image deployment/admin-service admin-service=${DOCKER_REGISTRY}/admin-service:${BUILD_NUMBER} -n production'
                sh 'kubectl set image deployment/order-worker order-worker=${DOCKER_REGISTRY}/order-worker:${BUILD_NUMBER} -n production'
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            slackSend channel: '#deployments', 
                     color: 'good', 
                     message: "✅ Build ${BUILD_NUMBER} deployed successfully"
        }
        failure {
            slackSend channel: '#deployments', 
                     color: 'danger', 
                     message: "❌ Build ${BUILD_NUMBER} failed"
        }
    }
}